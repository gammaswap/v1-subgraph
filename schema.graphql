enum LoanStatus {
  OPEN
  CLOSED
  LIQUIDATED_PARTIAL
  LIQUIDATED_FULL
}

type GammaPool @entity {
  id: ID!         # {PoolAddress}
  address: Bytes!
  cfmm: Bytes!
  protocolId: BigInt!
  token0: Bytes!
  token0Symbol: String!
  token0Decimals: BigInt!
  token1: Bytes!
  token1Symbol: String!
  token1Decimals: BigInt!

  lpBalance: BigInt!
  lpBorrowedBalance: BigInt!
  lpBorrowedBalancePlusInterest: BigInt!
  lpInvariant: BigInt!
  lpBorrowedInvariant: BigInt!

  accFeeIndex: BigInt!
  lastCfmmFeeIndex: BigInt!
  lastCfmmInvariant: BigInt!
  lastCfmmTotalSupply: BigInt!
  lastFeeIndex: BigInt!
  lastPrice: BigInt!

  totalSupply: BigInt!
  token0Balance: BigInt!
  token1Balance: BigInt!
  reserve0Balance: BigInt!
  reserve1Balance: BigInt!
  borrowRate: BigInt!
  supplyRate: BigInt!
  utilizationRate: BigInt!
  ltvThreshold: BigInt!
  liquidationFee: BigInt!

  block: BigInt!
  timestamp: BigInt!

  loans: [Loan!] @derivedFrom(field: "pool")
  liquidations: [Liquidation!] @derivedFrom(field: "pool")
}

type Loan @entity {
  id: ID!           # {PoolAddress}-{tokenId}
  tokenId: String!
  pool: GammaPool!
  account: Account!

  # TODO
  # creation loan event: PositionManager or other contract or EOA, determine actual owner of the loan

  rateIndex: BigInt!
  initLiquidity: BigInt!
  liquidity: BigInt!
  lpTokens: BigInt!
  token0Held: BigInt!
  token1Held: BigInt!
  price: BigInt!

  status: LoanStatus!
  openedBlock: BigInt!
  openedTimestamp: BigInt!
  closedBlock: BigInt
  closedTimestamp: BigInt

  liquidations: [Liquidation!] @derivedFrom(field: "loan")
}

type Liquidation @entity {
  id: ID!           # {PoolAddress}-{tokenId}-{index}
  pool: GammaPool!
  loan: Loan!
  liquidator: Account!

  collateral: BigInt!
  liquidity: BigInt!
  writeDown: BigInt!

  block: BigInt!
  timestamp: BigInt!
}

type VaultBalance @entity {
  id: ID!           # {PoolAddress}-{account}
  pool: GammaPool!
  account: Account!
  balance: BigInt!
}

type Account @entity {
  id: ID!           # {account}
  loans: [Loan!] @derivedFrom(field: "account")
  liquidations: [Liquidation!] @derivedFrom(field: "liquidator")
  vaultBalances: [VaultBalance!] @derivedFrom(field: "account")
}